<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Medit STL loader</title>
    <style>
        body
        {
            margin: 0;
        }
        canvas
        {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<script type="text/javascript" src="js/three.min.js"> </script>
<script type="text/javascript" src="js/loaders/STLLoader.js"> </script>
<script type="text/javascript" src="js/OrbitControls.js"></script>
<script type="text/javascript" src="js/TrackballControls.js"></script>

<script>
    var WIDTH = window.innerWidth;
    var HEIGHT = window.innerHeight;
    var renderer = new THREE.WebGLRenderer({antialias:true});
    var scene = new THREE.Scene();
    var field_of_view = 70;
    var camera = new THREE.PerspectiveCamera(field_of_view, WIDTH/HEIGHT);
    var controls;
    var object_width, object_height;
    var object_y_pos;
    var mesh;
    var bbHelper;
    var boundingBox;

    init();
    animate();

    function render() {
        renderer.render(scene, camera);
    }

    function init() {
        define_renderer();

        create_stl_object();
        //create_object_bounding_box();

        add_axis_helper();

        add_arrow_helper(1.8, -46.3, 4.4);
        add_arrow_helper(63.8, 3.6, 25.5);

        //add_camera_helper();

        add_gridHelper();

//        create_light_up();
        create_light_down();

        define_camera(camera);

        render();

        //define_orbit_controls();
        define_trackball_controls();

        window.addEventListener('resize', onWindowResize);
    }

    function animate() {
        requestAnimationFrame( animate );
        controls.update();
    }

    function onWindowResize() {
        var width = window.innerWidth;
        var height = window.innerHeight;
        renderer.setSize(width, height);
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        controls.handleResize();
    }

    function define_renderer() {
        renderer.setSize(WIDTH, HEIGHT);
        renderer.setClearColor(0x000000, 1);
        document.body.appendChild(renderer.domElement);
    }

    function add_axis_helper() {
        var axisHelper = new THREE.AxisHelper( 100 );
        scene.add( axisHelper );
    }

    function add_camera_helper() {
        var helper = new THREE.CameraHelper( camera );
        scene.add( helper );
    }

    function define_camera(camera) {
        var fov = field_of_view * ( Math.PI / 180 );
        var objectSize = Math.max(object_height, object_width);

        var cameraPosition = new THREE.Vector3(
            0,
            object_y_pos + Math.abs( objectSize / Math.sin( fov / 2 ) ),
            0
        );

        camera.position.set(0, 0, 70);
        //camera.position.set(0, object_y_pos + Math.abs( objectSize / Math.sin( fov / 2 ) ), 0);
        //camera.lookAt(new THREE.Vector3(0,0,0));
        scene.add(camera);
    }

    function add_gridHelper() {
        var size = 100;
        var divisions = 10;

        var gridHelper = new THREE.GridHelper( size, divisions );
        scene.add( gridHelper );
    }

    function add_arrow_helper(x,y,z) {
        var dir = new THREE.Vector3( x, y, z );

        var vec_size = dir.size;

//normalize the direction vector (convert to vector of length 1)
        dir.normalize();

        var origin = new THREE.Vector3( 0, 0, 0 );
        var length = 1;
        var hex = 0xff9933;

        var arrowHelper = new THREE.ArrowHelper( dir, origin, 65, hex );
        scene.add( arrowHelper );
    }

    function create_stl_object() {
        var stl_loader = new THREE.STLLoader();
        var material = new THREE.MeshPhongMaterial({color: 0xFFEFCC, specular: 0x111111, shininess: 200});
//        var stl_file = './models/stl/binary/2011-02-09_00001-001-36-35-34-33-32-31-41-42-43-44-45-46-bitesplint_cad.stl';
//        var stl_file = './models/stl/binary/2011-02-09_00001-001-lowerjaw.stl';
        var stl_file = './models/stl/binary/2011-02-09_00001-001-upperjaw.stl';
//        var stl_file = './models/stl/binary/2011-02-11_00001-007-upperjaw.stl';
//        var stl_file = './models/stl/binary/2011-02-11_00001-010-11-abutment_cad.stl';
//        var stl_file = './models/stl/binary/2011-02-11_00001-010-lowerjaw.stl';
//        var stl_file = './models/stl/binary/2011-02-11_00001-010-upperjaw.stl';
//        var stl_file = './models/stl/binary/2011-02-11_00001-010-upperjaw-gingiva.stl';
//        var stl_file = './models/stl/binary/2011-02-11_00001-010-upperjaw-marker.stl';
//        var stl_file = './models/stl/binary/2011-02-11_00001-011.stl';
//        var stl_file = './models/stl/binary/2011-02-14_00001-001.stl';

        stl_loader.load( stl_file, function ( geometry ) {
            mesh = new THREE.Mesh( geometry, material );
            //mesh.position.set( 0, 0, 0 );

            /*
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            //mesh.rotation.set( - Math.PI / 2, 0.3, 0 );
            mesh.rotation.set( -1.5, 0.3, -1.7 );
            mesh.scale.set( 2, 2, 2 );
            camera.lookAt(mesh.position);
             */
            create_object_bounding_box();

            geometry.computeBoundingBox();  // otherwise geometry.boundingBox will be undefined

            boundingBox = geometry.boundingBox.clone();

            console.log ('bounding box coordinates: ' +
                '(' + boundingBox.min.x + ', ' + boundingBox.min.y + ', ' + boundingBox.min.z + '), ' +
                '(' + boundingBox.max.x + ', ' + boundingBox.max.y + ', ' + boundingBox.max.z + ')' );

            mesh.position.set( -(boundingBox.max.x + boundingBox.min.x)/2, -(boundingBox.max.y + boundingBox.min.y)/2, -(boundingBox.max.z + boundingBox.min.z)/2);

            //var helper = new THREE.VertexNormalsHelper( mesh, 0.1, 0x00ff00, 0.1 );
            //scene.add( helper );

            scene.add( mesh );
        } );
    }

    function create_object_bounding_box() {
        bbHelper = new THREE.BoxHelper(mesh, 0xffffff);
        bbHelper.visible = true;
        bbHelper.update(mesh);
//        object_width = bbHelper.width;
//        object_height = bbHelper.height;
//        object_width = bbHelper;
//        object_height = bbHelper.box.max();
        scene.add(bbHelper);
    }

    function create_light_up() {
        //var light = new THREE.PointLight(0xFFFFFF);
        //light.position.set(-10, 15, 50);
        var light = new THREE.HemisphereLight( 0xffffbb, 0x080820, 1.0 );
        //var light = new THREE.AmbientLight( 0x00F0F0 );
        light.position.set(0,0,100);
        var helper = new THREE.HemisphereLightHelper(light, 100);
        scene.add(helper);
        scene.add(light);
    }

    function create_light_down() {
        //var light = new THREE.PointLight(0xFFFFFF);
        //light.position.set(-10, 15, 50);
        var light = new THREE.HemisphereLight( 0xffffbb, 0x080820, 1.0 );
        //var light = new THREE.AmbientLight( 0x00F0F0 );
        light.position.set(0,0,-100);
        var helper = new THREE.HemisphereLightHelper(light, 120);
        scene.add(helper);
        scene.add(light);
    }

    function define_orbit_controls() {
        // Add OrbitControls so that we can pan around with the mouse.
         controls = new THREE.OrbitControls(camera, renderer.domElement);
        /*
         var controls = new THREE.TrackballControls( camera );
         controls.rotateSpeed = 1.0;
         controls.zoomSpeed = 1.2;
         controls.panSpeed = 0.8;
         controls.noZoom = false;
         controls.noPan = false;
         controls.staticMoving = true;
         controls.dynamicDampingFactor = 0.3;
         controls.keys = [ 65, 83, 68 ];
         controls.addEventListener( 'change', render );
         */
    }

    function define_trackball_controls() {
        controls = new THREE.TrackballControls( camera );
        controls.rotateSpeed = 2;
        controls.panSpeed = 0.8;
        controls.noZoom = false;
        controls.noPan = false;
        controls.staticMoving = true;
        controls.dynamicDampingFactor = 0.3;
        controls.keys = [ 65, 83, 68 ];
        controls.addEventListener( 'change', render );
    }

</script>

</body>
</html>